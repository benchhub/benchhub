# Store

- issues
  - Rethink node, job https://github.com/benchhub/benchhub/issues/30
  - Job status stages https://github.com/benchhub/benchhub/issues/27

## Categories

### Meta Store for current state

- mainly used to keep state of the cluster, all updates goes through central
  - currently, the implementation is a map with lock in central
- static 'tables', once created, rarely update
  - node info
  - job spec
- dynamic 'tables'
  - node status, job assigned to it, status of running jobs
  - job general status (also used as job queue)
  - job detail status (aggregation from multiple stages and multiple nodes)

### Meta Store for historical data

- log state change based on event from pub/sub
  - node register history
  - job update history
- snap shot of operating system before and after each task, stage, job
- result of benchmark (aggregated)

### Time Series Store

- metrics collected by agent when running job
- benchmark result that can be expressed as time series, i.e. latency, (moving throughput?)


## Schemas

node_info

- id string (currently generated by node itself instead of assigned by central, using ip + host)
- host string host name
- addr struct for ip address, agent relies on central to know its ip address in the cluster
- start time
- boot time
- role preferred role in config
- provider struct for cloud service provider
- capacity struct for hardware capacity

job_spec

- id string (generated from store)
  - [ ] TODO: need to move id out
- hash string hash of entire job spec
- spec struct decoded from yaml string
- [ ] assigned nodes

job_status

- id string
- stage int/string
- status/state int/string, created/running/error/finished
- create_time, update_time time
- [ ] assigned nodes

node_status

- id string, refer to node_info
  - [ ] TODO: might de-normalize in current in-mem implementation and have method `GetNodeStatusWithNode`
- state string/int idle, job running, etc.
- job_count int, number of jobs currently running on this node
- role string/int, current role of node, loader, database
- heartbeat time, last time central got the node's heartbeat
- jobs []string, id of jobs running on the node

node_job_status

- node_id string
- job_id string
- stage int/string? current stage
- start_time
- finish_time
- status/state int/string, running, finished, error, canceled
- [ ] TODO: each job has pipeline of stages, each stages have pipeline of tasks

node_job_stage_pipeline_status

node_job_stage_status

node_job_task_pipeline_status

node_job_task_status



